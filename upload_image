from fastapi import FastAPI
from pydantic import BaseModel
import pickle
import pandas as pd
from fastai.vision.all import *
from fastapi import FastAPI, UploadFile, File
import shutil
import os

             
app = FastAPI()

@app.post('/image')

async def root(file: UploadFile = File(...)):
	
	with open(f'{file.filename}','wb') as buffer:
		shutil.copyfileobj(file.file, buffer)

	learn = load_learner('model2.pkl')
	result = list(learn.predict(item=r'C:\Users\IKIT-SILA\Desktop\Pr\\'+file.filename))

	name_pred = str(result[1])
	name_pred = int(name_pred[name_pred.find('(')+1:name_pred.find(')')])
	perc_pred = str(result[2][name_pred])
	perc_pred = round(float(perc_pred[perc_pred.find('(')+1:perc_pred.find(')')]),2)

	os.remove(file.filename)

	if perc_pred >= 0.9:
		return {"material": result[0]}
	else:
		return {}



